<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no, email=no" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" /><!-- 删除苹果默认的工具栏和菜单栏 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black" /><!-- 设置苹果工具栏颜色 -->
    <meta name="format-detection" content="telphone=no, email=no" /><!-- 忽略页面中的数字识别为电话，忽略email识别 -->
    <!-- 启用360浏览器的极速模式(webkit) -->
    <meta name="renderer" content="webkit">
    <!-- 避免IE使用兼容模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 针对手持设备优化，主要是针对一些老的不识别viewport的浏览器，比如黑莓 -->
    <meta name="HandheldFriendly" content="true">
    <!-- 微软的老式浏览器 -->
    <meta name="MobileOptimized" content="320">
    <!-- uc强制竖屏 -->
    <meta name="screen-orientation" content="portrait">
    <!-- QQ强制竖屏 -->
    <meta name="x5-orientation" content="portrait">
    <!-- UC强制全屏 -->
    <meta name="full-screen" content="yes">
    <!-- QQ强制全屏 -->
    <meta name="x5-fullscreen" content="true">
    <!-- UC应用模式 -->
    <meta name="browsermode" content="application">
    <!-- QQ应用模式 -->
    <meta name="x5-page-mode" content="app">
    <!-- windows phone 点击无高光 -->
    <meta name="msapplication-tap-highlight" content="no">
    <!-- 适应移动端end -->

    <!-- seo -->
    <meta name="description" content="Colorful，一个骚年路过这里，与你一起探讨关于前端技术，设计，Hack的奥秘。">
    <meta name="keyword" content="COLORFUL, Colorful, colorful, Archer, archer, 小A, 前端博客，前端工程师">
    <meta name="baidu-site-verification" content="FgaJaRYy0x" />

    <title>COLORFUL - 有个骚年路过这里</title>
    <link rel="stylesheet" href="/assets/dist/theme.css?ver=2.0.6"/>
</head>
<body>

<!-- self ribbon -->
<a href="https://github.com/qddegtya/qddegtya.github.io"><img style="position: fixed; top: 0; left: 0; border: 0; z-index: 99999;" src="/assets/images/forkme_darkblue.png" alt="Fork me on GitHub"></a>

<header id="blog__header">
    <div class="blog__bighead">
        <div class="blog__head__img">
            <span class="logo--name bounceInDown">COLORFUL</span>
            <span class="logo--des">有个骚年路过这里</span>
        </div>
    </div>

    <!-- blog nav -->
    <div class="blog__nav">
        <ul class="blog__nav__ul">
            <li class="blog__nav__item current"><a href="/" class="navlink">HOME</a></li>
            <li class="blog__nav__item"><a href="/tags" class="navlink">TAGS</a></li>
            <li class="blog__nav__item"><a href="/archives" class="navlink">POSTS</a></li>
            <li class="blog__nav__item"><a href="/works" class="navlink">WORKS</a></li>
            <li class="blog__nav__item"><a href="/about" class="navlink">ABOUT</a></li>
        </ul>
    </div>
</header>

<section id="blogbody">
    <div class="clearleft bloglooparea">
        <div class="bloglists">
            <div class="blogbody__everyblog">
                <div class="blogbody__everyblog__header">
                    <a href="/blog/2016/04/10/koa-middlewares-explain/">KOA源码阅读系列（一） - 理解KOA中间件的执行</a>
                </div>
                <div class="blogbody__everyblog__meta">
                    <span class="blogbody__everyblog__metainfo">2016 - 04 - 10</span>
                </div>
                <div class="blogbody__everyblog__tag">
                  
                    <span class="blogbody__tag__class"><a href="/tags/#javascript">javascript</a></span>
                  
                    <span class="blogbody__tag__class"><a href="/tags/#node">node</a></span>
                  
                </div>
                <div class="blogcontent blogbody__everyblog__excerpt" id="singleblogcontent">
                    <p>源码阅读系列的开篇就不多废话了，开门见山。</p>

<p>首先看添加中间件的入口app.use的源码</p>

<p>```javascript
/**
 * Use the given middleware <code class="highlighter-rouge">fn</code>.
 *
 * <a href="https://github.com/param" class="user-mention"><a href="https://github.com/param" class="user-mention">@param</a></a> {GeneratorFunction} fn
 * <a href="https://github.com/return" class="user-mention"><a href="https://github.com/return" class="user-mention">@return</a></a> {Application} self
 * <a href="https://github.com/api" class="user-mention"><a href="https://github.com/api" class="user-mention">@api</a></a> public
 */</p>

<p>app.use = function(fn){
  if (!this.experimental) {
    // es7 async functions are not allowed,
    // so we have to make sure that <code class="highlighter-rouge">fn</code> is a generator function
    assert(fn &amp;&amp; ‘GeneratorFunction’ == fn.constructor.name, ‘app.use() requires a generator function’);
  }
  debug(‘use %s’, fn._name || fn.name || ‘-‘);</p>

<p>// 主要就是做这个事情
  // 根据上面的assert，这里的fn均为generator function
  this.middleware.push(fn);
  return this;
};</p>

<p>```</p>

<!-- more -->

<p>接着，来看一下Server是怎么起来的</p>

<p>```javascript
/**
 * Shorthand for:
 *
 *    http.createServer(app.callback()).listen(…)
 *
 * <a href="https://github.com/param" class="user-mention"><a href="https://github.com/param" class="user-mention">@param</a></a> {Mixed} …
 * <a href="https://github.com/return" class="user-mention"><a href="https://github.com/return" class="user-mention">@return</a></a> {Server}
 * <a href="https://github.com/api" class="user-mention"><a href="https://github.com/api" class="user-mention">@api</a></a> public
 */</p>

<p>app.listen = function(){
  debug(‘listen’);</p>

<p>// 非常熟悉的createServer
  // 调用的是app.callback
  var server = http.createServer(this.callback());
  return server.listen.apply(server, arguments);
};
```</p>

<p>很显然，app.callback里应该就有我们想要的中间件执行的部分</p>

<p>```javascript
/**
 * Return a request handler callback
 * for node’s native http server.
 *
 * <a href="https://github.com/return" class="user-mention"><a href="https://github.com/return" class="user-mention">@return</a></a> {Function}
 * <a href="https://github.com/api" class="user-mention"><a href="https://github.com/api" class="user-mention">@api</a></a> public
 */</p>

<p>app.callback = function(){
  if (this.experimental) {
    console.error(‘Experimental ES7 Async Function support is deprecated. Please look into Koa v2 as the middleware signature has changed.’)
  }</p>

<p>var fn = this.experimental
    ? compose_es7(this.middleware)
    : co.wrap(compose(this.middleware)); // 把中间件串起来
  var self = this;</p>

<p>if (!this.listeners(‘error’).length) this.on(‘error’, this.onerror);</p>

<p>return function(req, res){
    res.statusCode = 404;
    var ctx = self.createContext(req, res);
    onFinished(res, ctx.onerror);
    fn.call(ctx).then(function () {
      respond.call(ctx);
    }).catch(ctx.onerror);
  }
};
```</p>

<p>这里的compose是关键，我们来到koa-compose的源码，仅仅就这38行代码，就构成了KOA中间件执行的核心部分，这里我们暂且不讨论co.wrap</p>

<p>```javascript
/**
 * Expose compositor.
 */</p>

<p>module.exports = compose;</p>

<p>/**
 * Compose <code class="highlighter-rouge">middleware</code> returning
 * a fully valid middleware comprised
 * of all those which are passed.
 *
 * <a href="https://github.com/param" class="user-mention"><a href="https://github.com/param" class="user-mention">@param</a></a> {Array} middleware
 * <a href="https://github.com/return" class="user-mention"><a href="https://github.com/return" class="user-mention">@return</a></a> {Function}
 * <a href="https://github.com/api" class="user-mention"><a href="https://github.com/api" class="user-mention">@api</a></a> public
 */</p>

<p>function compose(middleware){
  return function *(next){
    if (!next) next = noop();</p>

<div class="highlighter-rouge"><pre class="highlight"><code>var i = middleware.length;

while (i--) {
  next = middleware[i].call(this, next);
}

return yield *next;   } }
</code></pre>
</div>

<p>/**
 * Noop.
 *
 * <a href="https://github.com/api" class="user-mention"><a href="https://github.com/api" class="user-mention">@api</a></a> private
 */</p>

<p>function *noop(){}
```</p>

<p>这么快就看到这行了？我觉得上面的代码信息量很大，道友们再细细品味一下，确定品味完了，下面的开胃DEMO可以帮助你更好的理解这个执行过程</p>

<p>```javascript
#!/usr/bin/env node</p>

<p>// 中间件 a
function* a(next) {
  yield 1;</p>

<p>// 执行下一个中间件
  yield* next;</p>

<p>yield ‘继续执行A中间件’;
}</p>

<p>// 中间件 b
function* b(next) {
  yield 2;
  yield 3;
}</p>

<p>var next = function* (){};
var i = [a, b].length;</p>

<p>// 通过next首尾相连
while(i–) {
  next = [a, b][i].call(null, next);
}</p>

<p>// 包裹第一个middleware
function* start(ne) {
  return yield* ne;
}</p>

<p>// 输出
console.log(start(next).next());
console.log(start(next).next());
console.log(start(next).next());
console.log(start(next).next());
```</p>

<p>输出结果：</p>

<p><code class="highlighter-rouge">
➜  a-lab ./a
{ value: 1, done: false }
{ value: 2, done: false }
{ value: 3, done: false }
{ value: '继续执行A中间件', done: false }
</code></p>

<p>等等，我们的co去哪儿了？大家有没有发现上面Demo中和我们平时写KOA的不同之处，我们来看一下KOA的官方示例代码：</p>

<p>```
var koa = require(‘koa’);
var app = koa();</p>

<p>// x-response-time</p>

<p>app.use(function *(next){
  var start = new Date;
  yield next;
  var ms = new Date - start;
  this.set(‘X-Response-Time’, ms + ‘ms’);
});</p>

<p>// logger</p>

<p>app.use(function *(next){
  var start = new Date;
  yield next;
  var ms = new Date - start;
  console.log(‘%s %s - %s’, this.method, this.url, ms);
});</p>

<p>// response</p>

<p>app.use(function *(){
  this.body = ‘Hello World’;
});</p>

<p>app.listen(3000);
```</p>

<p>有没有发现？如果还没有发现我就公布答案啦：</p>

<blockquote>
  <p>根据上文，我们已经知道，那个负责把所有中间件串起来的next其实本身也是一个generator，但是，如果在Generater函数内部，调用另一个Generator函数，默认情况下是没有效果的，这个时候我们必须使用yield* next</p>
</blockquote>

<p>但是，我们写代码的时候明明写的是yield next啊，这就是co的奥秘之处了：</p>

<p>co做的事情就是帮我们”自动管理”generator的next，并根据调用返回的value做出不同的响应，他的原理其实是自动调用generator的next方法，然后通过toPromise方法，如果遇到一个generator就递归，这就是为什么我们只要写yield next的原因，因为co一旦检测到这个next还是个generater，那就再次co.call(this)</p>

<p><code class="highlighter-rouge">javascript
yield next;
</code></p>

<p>可以看一下这个toPromise</p>

<p>```javascript
/**
 * Convert a <code class="highlighter-rouge">yield</code>ed value into a promise.
 *
 * <a href="https://github.com/param" class="user-mention"><a href="https://github.com/param" class="user-mention">@param</a></a> {Mixed} obj
 * <a href="https://github.com/return" class="user-mention"><a href="https://github.com/return" class="user-mention">@return</a></a> {Promise}
 * <a href="https://github.com/api" class="user-mention"><a href="https://github.com/api" class="user-mention">@api</a></a> private
 */</p>

<p>function toPromise(obj) {
  if (!obj) return obj;
  if (isPromise(obj)) return obj;
  if (isGeneratorFunction(obj) || isGenerator(obj)) return co.call(this, obj);
  if (‘function’ == typeof obj) return thunkToPromise.call(this, obj);
  if (Array.isArray(obj)) return arrayToPromise.call(this, obj);
  if (isObject(obj)) return objectToPromise.call(this, obj);
  return obj;
}
```</p>

<p>有了这个函数，如果我们在项目中直接使用了DEMO中的</p>

<p><code class="highlighter-rouge">javascript
yield 1
</code></p>

<p>co就会给我们一个错误</p>

<p><code class="highlighter-rouge">
You may only yield a function, promise, generator, array, or object.
</code></p>

<p>所以，我们一般在项目中如果想要”同步”写法，都会用Promise封装一下，比如这样：</p>

<p>```javascript
let getAuthInfo = function(req) {
  return new Promise((resolve, reject) =&gt; {
    rp(req)
    .then((authres) =&gt; {
      debug(<code class="highlighter-rouge">用户中心响应结果: ${JSON.stringify(authres)}</code>);</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  if(authres.status === 0 &amp;&amp; authres.code === 0) {
    resolve(authres);
  } else {
    resolve(null);
  }
})
.catch((err) =&gt; {
  reject(err);
});   }); }; ```
</code></pre>
</div>

<p>然后，我们就可以愉快地这样使用了：</p>

<p><code class="highlighter-rouge">
let authinfo = yield getAuthInfo(authReq);
</code></p>

<h3 id="section">总结</h3>

<ul>
  <li>
    <p>KOA通过next将中间件”串”了起来，形成了链表，然后通过最外层的generator function触发整个执行过程</p>
  </li>
  <li>
    <p>在compose的时候，拿取中间件的顺序是FILO的，但是拿出来之后做的操作是循环i–赋值next，因此，依然可以保证正确的顺序执行</p>
  </li>
  <li>
    <p>KOA框架中充斥着各种generater的思想，并且通过co来自动管理generater</p>
  </li>
  <li>
    <p>因此在KOA中使用中间件是很愉快的事情，在这个过程中你可以随心所欲做你想做的事情，比如改一个body咋样?</p>
  </li>
</ul>

                </div>
                <div class="blogbody__everyblog__footer">
                    <div class="footercopyright">
                        <span>转载请注明出处</span>
                        <span class="blogperlink">http://xiaoa.name/blog/2016/04/10/koa-middlewares-explain/</span>
                    </div>
                </div>
            </div>

        <div id="comments" class="comments">
  <div id="disqus_thread"></div>
  <script>
  /**
  * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
  */
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');

  s.src = '//colorful-archer.disqus.com/embed.js';

  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
</div>

        </div>
        
          <div class="blogsidebar">
    <!-- 简介 -->
    <div class="blogsidebar_item author_item">
        <h3 class="sidebar_title">AUTHOR</h3>
        <p class="sidebar_detail clearfix">
            <img src="/assets/images/js-avatar.jpg" class="avatar_detail" alt=""/>
            此人患有重度强迫症，逼格崇拜症，红色性格狂躁症。
            想让他安静下来，给他读一篇技术文章就好。
            目前沉浸在Javascript的世界里无法自拔。
        </p>
    </div>

    <!-- 足迹 -->
    <div class="blogsidebar_item author_item">
        <h3 class="sidebar_title">FOLLOW</h3>
        <div id="sidebar_follows" class="sidebar_follows">
          <ul>
            
              
              <li><a href="http://gold.xitu.io/#/user/564596b360b25b79f069ad76" title="稀土掘金" target="_blank"><img src="http://gold.xitu.io/favicon.ico" alt="" class="site--fav"/>稀土掘金</a></li>
              
            
              
              <li><a href="https://github.com/qddegtya" title="GITHUB" target="_blank"><img src="https://github.com/favicon.ico" alt="" class="site--fav"/>GITHUB</a></li>
              
            
              
              <li><a href="http://weibo.com/IMArcher" title="微博" target="_blank"><img src="http://weibo.com/favicon.ico" alt="" class="site--fav"/>微博</a></li>
              
            
              
              <li><a href="https://coding.net/u/archer" title="CODING" target="_blank"><img src="https://coding.net/favicon.ico" alt="" class="site--fav"/>CODING</a></li>
              
            
              
              <li><a href="http://my.oschina.net/Archerminia" title="开源中国" target="_blank"><img src="http://oschina.net/favicon.ico" alt="" class="site--fav"/>开源中国</a></li>
              
            
              
              <li><a href="https://www.zhihu.com/people/archer_xiaoa" title="知乎" target="_blank"><img src="https://www.zhihu.com/favicon.ico" alt="" class="site--fav"/>知乎</a></li>
              
            
          </ul>
        </div>
    </div>

    <!-- 标签云 -->
    <div class="blogsidebar_item author_item">
        <h3 class="sidebar_title">TAGS</h3>
        <div id="side_tags">
          
            
            <span class="blogbody__tag__class"><a href="/tags/#python">python</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#jython">jython</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#fe">fe</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#tool">tool</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#weixin">weixin</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#flask">flask</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#svg">svg</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#javascript">javascript</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#react-native">react-native</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#vue">vue</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#github">github</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#jekyll">jekyll</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#life">life</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#video">video</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#git">git</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#play">play</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#react">react</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#node">node</a></span>
            
          
        </div>
    </div>


    <!-- 足迹 -->
    <div class="blogsidebar_item author_item">
        <h3 class="sidebar_title">FRIENDS</h3>
        <div id="sidebar_follows" class="sidebar_follows">
          <ul>
            
              
              <li><a href="http://jiafeifei.weebly.com/" title="鲍勃の部屋" target="_blank"><img src="http://www.xiaoa.name/favicon.ico" alt="" class="site--fav"/>鲍勃の部屋</a></li>
              
            
              
              <li><a href="http://zixiinlian.github.io/" title="zixin’s blog" target="_blank"><img src="http://www.xiaoa.name/favicon.ico" alt="" class="site--fav"/>zixin’s blog</a></li>
              
            
              
              <li><a href="http://kyon-df.com/" title="Kyonko记录站" target="_blank"><img src="http://www.xiaoa.name/favicon.ico" alt="" class="site--fav"/>Kyonko记录站</a></li>
              
            
          </ul>
        </div>
    </div>

</div>

        
    </div>
</section>


<footer id="blogfooter" class="blogfooter">
    <h3 class="footer-title">COLORFUL</h3>
    <span class="copyright">Powered By <a href="http://jekyllrb.com/" title="Jekyll">Jekyll</a> / Theme is <a href="http://xiaoa.name/" title="Colorful">Colorful</a></span>
</footer>

</body>
</html>

