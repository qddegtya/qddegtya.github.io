<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no, email=no" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" /><!-- 删除苹果默认的工具栏和菜单栏 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black" /><!-- 设置苹果工具栏颜色 -->
    <meta name="format-detection" content="telphone=no, email=no" /><!-- 忽略页面中的数字识别为电话，忽略email识别 -->
    <!-- 启用360浏览器的极速模式(webkit) -->
    <meta name="renderer" content="webkit">
    <!-- 避免IE使用兼容模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 针对手持设备优化，主要是针对一些老的不识别viewport的浏览器，比如黑莓 -->
    <meta name="HandheldFriendly" content="true">
    <!-- 微软的老式浏览器 -->
    <meta name="MobileOptimized" content="320">
    <!-- uc强制竖屏 -->
    <meta name="screen-orientation" content="portrait">
    <!-- QQ强制竖屏 -->
    <meta name="x5-orientation" content="portrait">
    <!-- UC强制全屏 -->
    <meta name="full-screen" content="yes">
    <!-- QQ强制全屏 -->
    <meta name="x5-fullscreen" content="true">
    <!-- UC应用模式 -->
    <meta name="browsermode" content="application">
    <!-- QQ应用模式 -->
    <meta name="x5-page-mode" content="app">
    <!-- windows phone 点击无高光 -->
    <meta name="msapplication-tap-highlight" content="no">
    <!-- 适应移动端end -->

    <!-- seo -->
    <meta name="description" content="Colorful，一个骚年路过这里，与你一起探讨关于前端技术，设计，Hack的奥秘。">
    <meta name="keyword" content="COLORFUL, Colorful, colorful, Archer, archer, 小A, 前端博客，前端工程师">
    <meta name="baidu-site-verification" content="FgaJaRYy0x" />

    <title>COLORFUL - 有个骚年路过这里</title>
    <link rel="stylesheet" href="/assets/dist/theme.css?ver=2.0.6"/>
</head>
<body>

<!-- self ribbon -->
<a href="https://github.com/qddegtya/qddegtya.github.io"><img style="position: fixed; top: 0; left: 0; border: 0; z-index: 99999;" src="/assets/images/forkme_darkblue.png" alt="Fork me on GitHub"></a>

<header id="blog__header">
    <div class="blog__bighead">
        <div class="blog__head__img">
            <span class="logo--name bounceInDown">COLORFUL</span>
            <span class="logo--des">有个骚年路过这里</span>
        </div>
    </div>

    <!-- blog nav -->
    <div class="blog__nav">
        <ul class="blog__nav__ul">
            <li class="blog__nav__item current"><a href="/" class="navlink">HOME</a></li>
            <li class="blog__nav__item"><a href="/tags" class="navlink">TAGS</a></li>
            <li class="blog__nav__item"><a href="/archives" class="navlink">POSTS</a></li>
            <li class="blog__nav__item"><a href="/works" class="navlink">WORKS</a></li>
            <li class="blog__nav__item"><a href="/about" class="navlink">ABOUT</a></li>
        </ul>
    </div>
</header>

<section id="blogbody">
    <div class="clearleft bloglooparea">
        <div class="bloglists">
            <div class="blogbody__everyblog">
                <div class="blogbody__everyblog__header">
                    <a href="/blog/2015/02/01/flask-weixin/">微信JS-SDK签名接入flask版</a>
                </div>
                <div class="blogbody__everyblog__meta">
                    <span class="blogbody__everyblog__metainfo">2015 - 02 - 01</span>
                </div>
                <div class="blogbody__everyblog__tag">
                  
                    <span class="blogbody__tag__class"><a href="/tags/#weixin">weixin</a></span>
                  
                    <span class="blogbody__tag__class"><a href="/tags/#flask">flask</a></span>
                  
                    <span class="blogbody__tag__class"><a href="/tags/#python">python</a></span>
                  
                </div>
                <div class="blogcontent blogbody__everyblog__excerpt" id="singleblogcontent">
                    <p>相信很多做前端的朋友都已经注意到了微信今年的一系列大动作，当然，对于前端开发工作来讲，我觉得这本身就是一种非常不错的开放机会，
能够让我们更好地利用好微信这个平台，每次写博客都要废话一段前言……好吧，下面说说最近的JS-SDK那些事儿。</p>

<p><img src="/assets/blog-images/2015-2-1-flaskweixin/jssdk.png" alt="" /></p>

<!-- more -->

<h3 id="section">前端部分</h3>

<p>在前端部分，我们重点来看下JS-SDK的接入流程，从前端角度而言，大致是如下三个步骤：
wx.pre-wx.ready-wx.apicall(实际上没有这个apicall方法)。
我把它翻译成：接入-就绪-调用。
OK，如果这么说的话，嗯……So easy……But，当我们用代码的方式写出来，可能是这样一种情况：</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">jsTool</span> <span class="o">=</span> <span class="p">{};</span>

<span class="c1">//Get Access Token</span>
<span class="c1">// Need APPID &amp; APPSECRET</span>
<span class="nx">jsTool</span><span class="p">.</span><span class="nx">getAccessToken</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span>
         <span class="nx">callback</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="c1">//Get jsapi_ticket</span>
<span class="nx">jsTool</span><span class="p">.</span><span class="nx">getApiTicket</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getAccessToken</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">acCode</span><span class="p">){</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">){</span>
                <span class="nx">callback</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
                <span class="c1">//立即存下ticket</span>
            <span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>

<span class="c1">//Throw args to backend to checksign</span>
<span class="nx">jsTool</span><span class="p">.</span><span class="nx">getSignFromBackEnd</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span>
     <span class="nx">$ajax</span><span class="p">({</span>
          <span class="c1">//扔给后端参数中的timestamp和nonceStr必须跟wx.config一致</span>
          <span class="na">timestamp</span><span class="p">:</span> <span class="mi">145672831</span><span class="p">,</span>
          <span class="na">noncestr</span><span class="p">:</span> <span class="s2">"Wm3WZYTPz0wzccnW"</span>
          <span class="na">jsapi_ticket</span><span class="p">:</span> <span class="s2">"sM4AOVdWfPE4DxkX"</span> <span class="c1">//上面存下的ticket</span>
          <span class="na">url</span><span class="p">:</span> <span class="s2">"http://mp.weixin.qq.com"</span>
     <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sign</span><span class="p">){</span>
         <span class="nx">wx</span><span class="p">.</span><span class="nx">config</span><span class="p">({</span>
            <span class="na">debug</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// 开启调试模式</span>
            <span class="na">appId</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="c1">// 必填，公众号的唯一标识</span>
            <span class="na">timestamp</span><span class="p">:</span> <span class="p">,</span> <span class="c1">// 必填，生成签名的时间戳</span>
            <span class="na">nonceStr</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="c1">// 必填，生成签名的随机串</span>
            <span class="na">signature</span><span class="p">:</span> <span class="nx">sign</span><span class="p">,</span><span class="c1">// 必填，签名</span>
            <span class="na">jsApiList</span><span class="p">:</span> <span class="p">[</span><span class="nx">xxx</span><span class="p">,</span><span class="nx">xxx</span><span class="p">,</span><span class="nx">xxx</span><span class="p">,</span><span class="nx">xxx</span><span class="p">,</span><span class="nx">xxx</span><span class="p">]</span> <span class="c1">// 必填，需要使用的JS接口列表</span>
         <span class="p">});</span>
     <span class="p">});</span>
<span class="p">}</span></code></pre></figure>

<p>没错，如果按照官方文档的说明进行开发还是稍微显得有些复杂，主要是因为微信这次加入了签名策略。
那么，我们再来梳理一遍带签名的处理流程：</p>

<ol>
  <li>拿下全局token</li>
  <li>根据全局token拿到ticket</li>
  <li>一顿签名规则</li>
  <li>拿到签名</li>
  <li>wx.pre</li>
  <li>wx.ready</li>
  <li>wx.apicall</li>
</ol>

<p>我们只要想办法把wx.config需要的参数直接扔给前端，让他继续处理下面的事情就可以了，官方推荐的做法也是如此：
token和ticket建议存储，必要时签名等做成中置服务，让所有应用服务器都只用一个全局token。</p>

<p>说干就干，上flask版的代码：
我最终的思路是：让前端专心处理前端，让后端专心处理后端，通过restful风格的/all接口，我可以将wx.config需要的一系列参数全部直接返回给前端使用。
全局的token和ticket使用job的方式去单独处理他们的更新。
与官方推荐做法基本吻合：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># -*- coding:utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span>  <span class="n">make_response</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">CONFIG</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'SQLALCHEMY_DATABASE_URI'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'sqlite:///main.db'</span>  <span class="c"># 相对路径写法</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TokenAndTicket</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ticket</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">ticket</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticket</span> <span class="o">=</span> <span class="n">ticket</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">"&lt;TICKET </span><span class="si">%</span><span class="s">r&gt;"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ticket</span>


<span class="n">current_token_ticket</span> <span class="o">=</span> <span class="n">TokenAndTicket</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="c">#error code</span>
<span class="n">DONE</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c">#weixin token</span>
<span class="n">WX_TOKEN_REQ</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">"https://api.weixin.qq.com/cgi-bin/token?grant_type=</span><span class="si">%</span><span class="s">s&amp;appid=</span><span class="si">%</span><span class="s">s&amp;secret=</span><span class="si">%</span><span class="s">s"</span>
    <span class="o">%</span> <span class="p">(</span><span class="n">CONFIG</span><span class="p">[</span><span class="s">'client_credential'</span><span class="p">],</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s">"app_id"</span><span class="p">],</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s">"secret"</span><span class="p">])</span>
<span class="p">)</span>

<span class="c">#weixin js_ticket</span>
<span class="n">WX_TICKET_REQ</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">"https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=</span><span class="si">%</span><span class="s">s&amp;type=jsapi"</span> <span class="o">%</span> <span class="n">x</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/nonce'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">ge_nonce_str</span><span class="p">():</span>
    <span class="s">"""随机串单拿接口
    """</span>
    <span class="k">return</span> <span class="n">json_response</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s">"nonce_str"</span><span class="p">:</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_ge_nonce_str</span><span class="p">():</span>
    <span class="s">"""all in one 接口用
    """</span>
    <span class="k">return</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">error_res_obj</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="s">"""错误响应
    """</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">"errcode"</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
        <span class="s">"errmsg"</span><span class="p">:</span> <span class="n">msg</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">json_response</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
    <span class="s">"""包装response为json
    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">json_response_body</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">json_response_body</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">json_response_body</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Content-Type'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"application/json;charset=UTF-8"</span>  <span class="c"># 设置</span>
    <span class="c"># json_response_body.headers['Access-Control-Allow-Origin'] = "*"  # 跨域</span>
    <span class="k">return</span> <span class="n">json_response_body</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/token'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_access_token</span><span class="p">():</span>
    <span class="s">"""token单拿接口
    """</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">current_token_ticket</span><span class="o">.</span><span class="n">token</span>
    <span class="k">return</span> <span class="n">json_response</span><span class="p">({</span>
        <span class="s">"token"</span><span class="p">:</span> <span class="n">token</span>
    <span class="p">})</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/ticket'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">js_ticket</span><span class="p">():</span>
    <span class="s">"""ticket单拿接口
    """</span>
    <span class="n">ticket</span> <span class="o">=</span> <span class="n">current_token_ticket</span><span class="o">.</span><span class="n">ticket</span>
    <span class="k">return</span> <span class="n">json_response</span><span class="p">({</span>
        <span class="s">"ticket"</span><span class="p">:</span> <span class="n">ticket</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">_sign_ticket</span><span class="p">(</span><span class="n">nonce_str</span><span class="p">,</span> <span class="n">j_ticket</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="s">"""私有签名方法
    """</span>
    <span class="n">sign_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"jsapi_ticket"</span><span class="p">:</span> <span class="n">j_ticket</span><span class="p">,</span>
        <span class="s">"noncestr"</span><span class="p">:</span> <span class="n">nonce_str</span><span class="p">,</span>
        <span class="s">"timestamp"</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
        <span class="s">"url"</span><span class="p">:</span> <span class="n">url</span>
    <span class="p">}</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># 字典排序</span>
    <span class="n">sign_sorted_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sign_dict</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sign_sorted_list</span><span class="p">:</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">"="</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">_url_string</span> <span class="o">=</span> <span class="s">'&amp;'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">final_sign</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">_url_string</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">final_sign</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/all'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">all_in_one</span><span class="p">():</span>
    <span class="s">"""all in one数据返回
    """</span>
    <span class="n">_time_stamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">_random_str</span> <span class="o">=</span> <span class="n">_ge_nonce_str</span><span class="p">()</span>
    <span class="n">_js_ticket</span> <span class="o">=</span> <span class="n">current_token_ticket</span><span class="o">.</span><span class="n">ticket</span>
    <span class="n">_url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">host_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c"># 去除/</span>

    <span class="k">return</span> <span class="n">json_response</span><span class="p">({</span>
        <span class="s">'appId'</span><span class="p">:</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s">'app_id'</span><span class="p">],</span>
        <span class="s">'timestamp'</span><span class="p">:</span> <span class="n">_time_stamp</span><span class="p">,</span>
        <span class="s">'nonceStr'</span><span class="p">:</span> <span class="n">_random_str</span><span class="p">,</span>
        <span class="s">'signature'</span><span class="p">:</span> <span class="n">_sign_ticket</span><span class="p">(</span><span class="n">_random_str</span><span class="p">,</span> <span class="n">_js_ticket</span><span class="p">,</span> <span class="n">_time_stamp</span><span class="p">,</span> <span class="n">_url</span><span class="p">),</span>
        <span class="s">'url'</span><span class="p">:</span> <span class="n">_url</span>  <span class="c"># POST过来什么,返回什么</span>
    <span class="p">})</span>


<span class="k">def</span> <span class="nf">_detect_request</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/all'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">,</span> <span class="s">'GET'</span><span class="p">]):</span>
        <span class="k">print</span> <span class="nb">dir</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">request</span><span class="o">.</span><span class="n">host_url</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">"0.0.0.0"</span><span class="p">)</span>
    <span class="c"># _detect_request()</span></code></pre></figure>

<p>冬天写博客手真冷……</p>

<h3 id="github">Github</h3>

<p><a href="https://github.com/qddegtya/Weixin-Flask">Weixin-Flask</a></p>

                </div>
                <div class="blogbody__everyblog__footer">
                    <div class="footercopyright">
                        <span>转载请注明出处</span>
                        <span class="blogperlink">http://xiaoa.name/blog/2015/02/01/flask-weixin/</span>
                    </div>
                </div>
            </div>

        <div id="comments" class="comments">
  <div id="disqus_thread"></div>
  <script>
  /**
  * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
  */
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');

  s.src = '//colorful-archer.disqus.com/embed.js';

  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
</div>

        </div>

        <div class="blogsidebar">
    <!-- 简介 -->
    <div class="blogsidebar_item author_item">
        <h3 class="sidebar_title">AUTHOR</h3>
        <p class="sidebar_detail clearfix">
            <img src="/assets/images/js-avatar.jpg" class="avatar_detail" alt=""/>
            此人患有重度强迫症，逼格崇拜症，红色性格狂躁症。
            想让他安静下来，给他读一篇技术文章就好。
        </p>
    </div>

    <!-- 足迹 -->
    <div class="blogsidebar_item author_item">
        <h3 class="sidebar_title">FOLLOW</h3>
        <div id="sidebar_follows" class="sidebar_follows">
          <ul>
            
              
              <li><a href="http://gold.xitu.io/#/user/564596b360b25b79f069ad76" title="稀土掘金" target="_blank"><img src="http://gold.xitu.io/favicon.ico" alt="" class="site--fav"/>稀土掘金</a></li>
              
            
              
              <li><a href="https://github.com/qddegtya" title="GITHUB" target="_blank"><img src="https://github.com/favicon.ico" alt="" class="site--fav"/>GITHUB</a></li>
              
            
              
              <li><a href="http://weibo.com/IMArcher" title="微博" target="_blank"><img src="http://weibo.com/favicon.ico" alt="" class="site--fav"/>微博</a></li>
              
            
              
              <li><a href="https://coding.net/u/archer" title="CODING" target="_blank"><img src="https://coding.net/favicon.ico" alt="" class="site--fav"/>CODING</a></li>
              
            
              
              <li><a href="http://my.oschina.net/Archerminia" title="开源中国" target="_blank"><img src="http://oschina.net/favicon.ico" alt="" class="site--fav"/>开源中国</a></li>
              
            
          </ul>
        </div>
    </div>

    <!-- 标签云 -->
    <div class="blogsidebar_item author_item">
        <h3 class="sidebar_title">TAGS</h3>
        <div id="side_tags">
          
            
            <span class="blogbody__tag__class"><a href="/tags/#python">python</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#jython">jython</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#fe">fe</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#tool">tool</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#weixin">weixin</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#flask">flask</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#svg">svg</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#javascript">javascript</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#react-native">react-native</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#vue">vue</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#github">github</a></span>
            
          
            
            <span class="blogbody__tag__class"><a href="/tags/#jekyll">jekyll</a></span>
            
          
        </div>
    </div>


    <!-- 足迹 -->
    <div class="blogsidebar_item author_item">
        <h3 class="sidebar_title">FRIENDS</h3>
        <div id="sidebar_follows" class="sidebar_follows">
          <ul>
            
              
              <li><a href="http://jiafeifei.weebly.com/" title="鲍勃の部屋" target="_blank">鲍勃の部屋</a></li>
              
            
          </ul>
        </div>
    </div>

</div>

    </div>
</section>


<footer id="blogfooter" class="blogfooter">
    <h3 class="footer-title">COLORFUL</h3>
    <span class="copyright">Powered By <a href="http://jekyllrb.com/" title="Jekyll">Jekyll</a> / Theme is <a href="http://xiaoa.name/" title="Colorful">Colorful</a></span>
</footer>

</body>
</html>

